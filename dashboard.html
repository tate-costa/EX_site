<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gymnastics Dashboard</title>
  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // üî• Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üß± Event setup
    const events = [
      { name: "FX", skills: 8 },
      { name: "PH", skills: 8 },
      { name: "SR", skills: 8 },
      { name: "VT", skills: 3 },
      { name: "PB", skills: 8 },
      { name: "HB", skills: 8 }
    ];

    // üîê Auth check
    onAuthStateChanged(auth, user => {
      if (user) {
        window.currentUser = {
          uid: user.uid,
          email: user.email
        };
        buildDashboard();
      } else {
        window.location.href = "login.html";
      }
    });

    function buildDashboard() {
      const container = document.getElementById("dashboard");

      events.forEach(event => {
        const panel = document.createElement("div");
        panel.className = "event-panel";

        const title = document.createElement("h2");
        title.textContent = `Event: ${event.name}`;
        panel.appendChild(title);

        const table = document.createElement("table");
        const rowsHTML = Array.from({ length: event.skills }).map(() => `
          <tr>
            <td><input type="text" placeholder="Skill name"></td>
            <td><input type="number" placeholder="Score" step="0.1" min="0" max="10"></td>
          </tr>
        `).join('');

        table.innerHTML = `
          <thead>
            <tr><th>Skill</th><th>Score</th></tr>
          </thead>
          <tbody>${rowsHTML}</tbody>
        `;
        panel.appendChild(table);

        const submitBtn = document.createElement("button");
        submitBtn.className = "submitBtn";
        submitBtn.textContent = "Submit Scores";

        const statusMsg = document.createElement("p");
        statusMsg.className = "submitStatus";

        submitBtn.addEventListener("click", async () => {
          const rows = panel.querySelectorAll("tbody tr");
          const skills = [];

          rows.forEach(row => {
            const name = row.querySelector("input[type='text']").value.trim();
            const score = parseFloat(row.querySelector("input[type='number']").value);
            if (name && !isNaN(score)) {
              skills.push({ name, score });
            }
          });

          if (skills.length === 0) {
            statusMsg.textContent = "Please enter at least one skill and score.";
            return;
          }

          if (!window.currentUser) {
            statusMsg.textContent = "User not authenticated.";
            return;
          }

          try {
            const timestamp = new Date().toISOString();
            const docRef = doc(db, "submissions", `${window.currentUser.uid}_${timestamp}`);
            await setDoc(docRef, {
              uid: window.currentUser.uid,
              email: window.currentUser.email,
              event: event.name,
              skills: skills,
              submittedAt: timestamp
            });
            statusMsg.textContent = `‚úÖ Submitted on ${new Date().toLocaleString()}`;
          } catch (err) {
            console.error("Submission error:", err);
            statusMsg.textContent = "‚ùå Submission failed. Try again.";
          }
        });

        panel.appendChild(submitBtn);
        panel.appendChild(statusMsg);
        container.appendChild(panel);
      });
    }
  </script>

  <style>
    body { font-family: Arial; padding: 20px; background-color: #f9f9f9; }
    .event-panel { margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; border-radius: 6px; background: #fff; }
    .submitBtn { margin-top: 10px; padding: 8px 16px; background-color: #0077cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .submitStatus { font-style: italic; color: green; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; padding: 4px; }
  </style>
</head>
<body>
  <h1>Welcome to Your Gymnastics Dashboard</h1>
  <div id="dashboard"></div>
</body>
</html>
