<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gymnastics Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    .panel { margin-bottom: 30px; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
    .panel-header { padding: 10px; background: #eee; cursor: pointer; font-weight: bold; }
    .panel-body { display: none; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; padding: 4px; }
    .submitBtn, #loginBtn {
      margin-top: 10px; padding: 8px 16px;
      background-color: #0077cc; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .statusMsg { font-style: italic; margin-top: 5px; }
    .summary { font-weight: bold; background: #e0f7fa; }
  </style>
</head>
<body>
  <h1>Gymnastics Dashboard</h1>
  <button id="loginBtn" style="display:none;">Sign in with Google</button>
  <p id="userStatus">Checking login status...</p>
  <div id="panelsContainer"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148",
      appId: "1:123456789012:web:abcdef123456" // Replace with your actual App ID
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUserId = null;

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("userStatus").textContent = `Logged in as: ${user.displayName || user.email}`;
        document.getElementById("loginBtn").style.display = "none";
        renderPanels();
      } else {
        document.getElementById("userStatus").textContent = "Not signed in";
        document.getElementById("loginBtn").style.display = "inline-block";
      }
    });

    document.getElementById("loginBtn").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    });

    function renderPanels() {
      const events = { FX: 8, PH: 8, SR: 8, PB: 8, HB: 8, VT: 3 };
      const container = document.getElementById("panelsContainer");

      Object.entries(events).forEach(([event, rows]) => {
        const panel = document.createElement("div");
        panel.className = "panel";

        const header = document.createElement("div");
        header.className = "panel-header";
        header.textContent = `Event: ${event}`;
        header.addEventListener("click", () => {
          body.style.display = body.style.display === "none" ? "block" : "none";
        });

        const body = document.createElement("div");
        body.className = "panel-body";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead><tr><th>Skill</th><th>Value</th><th>Deduction</th></tr></thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        for (let i = 0; i < rows; i++) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="text" class="skillInput"></td>
            <td><input type="number" class="valueInput"></td>
            <td><input type="number" class="deductionInput"></td>
          `;
          tbody.appendChild(row);
        }

        const submitBtn = document.createElement("button");
        submitBtn.textContent = `Submit ${event}`;
        submitBtn.className = "submitBtn";

        const statusMsg = document.createElement("p");
        statusMsg.className = "statusMsg";

        const breakdownDiv = document.createElement("div");
        breakdownDiv.id = `breakdown-${event}`;

        submitBtn.addEventListener("click", () => {
          const skillInputs = body.querySelectorAll(".skillInput");
          const valueInputs = body.querySelectorAll(".valueInput");
          const deductionInputs = body.querySelectorAll(".deductionInput");

          const timestamp = new Date().toISOString();
          let totalValid = 0;
          let submittedCount = 0;

          skillInputs.forEach((input, i) => {
            const skill = input.value.trim();
            const value = parseFloat(valueInputs[i].value);
            const deduction = parseFloat(deductionInputs[i].value);

            if (!skill || isNaN(value) || isNaN(deduction)) return;

            totalValid++;

            db.collection("submissions").add({
              userId: currentUserId,
              event,
              skill,
              value,
              deduction,
              timestamp
            }).then(() => {
              submittedCount++;
              if (submittedCount === totalValid) {
                statusMsg.textContent = `✅ Submitted ${submittedCount} rows for ${event}`;
                skillInputs.forEach(input => input.value = "");
                valueInputs.forEach(input => input.value = "");
                deductionInputs.forEach(input => input.value = "");
                loadBreakdown(event, breakdownDiv);
              }
            }).catch(err => {
              console.error("Submission error:", err);
              statusMsg.textContent = "❌ Submission failed. Check console.";
              statusMsg.style.color = "red";
            });
          });

          if (totalValid === 0) {
            statusMsg.textContent = "⚠️ No valid rows to submit.";
            statusMsg.style.color = "red";
          }
        });

        body.appendChild(table);
        body.appendChild(submitBtn);
        body.appendChild(statusMsg);
        body.appendChild(breakdownDiv);

        panel.appendChild(header);
        panel.appendChild(body);
        container.appendChild(panel);

        loadBreakdown(event, breakdownDiv);
      });
    }

    function loadBreakdown(event, container) {
      db.collection("submissions")
        .where("userId", "==", currentUserId)
        .where("event", "==", event)
        .orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          container.innerHTML = `<h3>${event} Breakdown</h3>`;
          if (snapshot.empty) {
            container.innerHTML += "<p>No submissions yet.</p>";
            return;
          }

          const table = document.createElement("table");
          table.innerHTML = `
            <thead><tr><th>Skill</th><th>Value</th><th>Deduction</th><th>Net</th></tr></thead>
            <tbody></tbody>
          `;
          const tbody = table.querySelector("tbody");

          let totalValue = 0, totalDeduction = 0;

          snapshot.forEach(doc => {
            const { skill, value, deduction } = doc.data();
            const net = value - deduction;
            totalValue += value;
            totalDeduction += deduction;

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${skill}</td>
              <td>${value.toFixed(2)}</td>
              <td>${deduction.toFixed(2)}</td>
              <td>${net.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
          });

          const summaryRow = document.createElement("tr");
          summaryRow.className = "summary";
          summaryRow.innerHTML = `
            <td>Total</td>
            <td>${totalValue.toFixed(2)}</td>
            <td>${totalDeduction.toFixed(2)}</td>
            <td>${(totalValue - totalDeduction).toFixed(2)}</td>
          `;
          tbody.appendChild(summaryRow);

          container.appendChild(table);
        })
        .catch(err => {
          console.error("Breakdown load error:", err);
          container.innerHTML = "<p>Failed to load breakdown.</p>";
        });
    }
  </script>
</body>
</html>
``
