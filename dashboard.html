<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FX Dashboard Test</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; padding: 4px; }
    .submitBtn, #loginBtn {
      margin-top: 10px; padding: 8px 16px;
      background-color: #0077cc; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .statusMsg { font-style: italic; margin-top: 5px; }
    .summary { font-weight: bold; background: #e0f7fa; }
  </style>
</head>
<body>
  <h1>FX Dashboard Test</h1>
  <button id="loginBtn" style="display:none;">Sign in with Google</button>
  <p id="userStatus">Checking login status...</p>

  <table id="inputTable">
    <thead><tr><th>Skill</th><th>Value</th><th>Deduction</th></tr></thead>
    <tbody>
      <tr>
        <td><input type="text" class="skillInput"></td>
        <td><input type="number" class="valueInput"></td>
        <td><input type="number" class="deductionInput"></td>
      </tr>
      <tr>
        <td><input type="text" class="skillInput"></td>
        <td><input type="number" class="valueInput"></td>
        <td><input type="number" class="deductionInput"></td>
      </tr>
    </tbody>
  </table>

  <button class="submitBtn">Submit FX</button>
  <p class="statusMsg" id="statusMsg"></p>
  <div id="breakdown"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let currentUserId = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        console.log("✅ Logged in as:", currentUserId);
        document.getElementById("userStatus").textContent = `Logged in as: ${user.email}`;
        document.getElementById("loginBtn").style.display = "none";
        loadBreakdown();
      } else {
        console.log("❌ Not logged in");
        document.getElementById("userStatus").textContent = "Not signed in";
        document.getElementById("loginBtn").style.display = "inline-block";
      }
    });

    document.getElementById("loginBtn").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    });

    function getUserData() {
      const key = `submissions-${currentUserId}`;
      return JSON.parse(localStorage.getItem(key)) || [];
    }

    function saveUserData(data) {
      const key = `submissions-${currentUserId}`;
      localStorage.setItem(key, JSON.stringify(data));
    }

    document.querySelector(".submitBtn").addEventListener("click", () => {
      if (!currentUserId) {
        alert("Please sign in first");
        return;
      }

      const skillInputs = document.querySelectorAll(".skillInput");
      const valueInputs = document.querySelectorAll(".valueInput");
      const deductionInputs = document.querySelectorAll(".deductionInput");

      const timestamp = new Date().toISOString();
      let newEntries = [];

      skillInputs.forEach((input, i) => {
        const skill = input.value.trim();
        const value = parseFloat(valueInputs[i].value);
        const deduction = parseFloat(deductionInputs[i].value);

        if (!skill || isNaN(value) || isNaN(deduction)) return;

        newEntries.push({ event: "FX", skill, value, deduction, timestamp });
      });

      if (newEntries.length === 0) {
        document.getElementById("statusMsg").textContent = "⚠️ No valid rows to submit.";
        return;
      }

      const allData = getUserData();
      saveUserData([...allData, ...newEntries]);
      document.getElementById("statusMsg").textContent = `✅ Submitted ${newEntries.length} rows`;
      skillInputs.forEach(input => input.value = "");
      valueInputs.forEach(input => input.value = "");
      deductionInputs.forEach(input => input.value = "");
      loadBreakdown();
    });

    function loadBreakdown() {
      const data = getUserData().filter(entry => entry.event === "FX");
      const container = document.getElementById("breakdown");
      container.innerHTML = "<h3>FX Breakdown</h3>";

      if (data.length === 0) {
        container.innerHTML += "<p>No submissions yet.</p>";
        return;
      }

      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr><th>Skill</th><th>Value</th><th>Deduction</th><th>Net</th></tr></thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      let totalValue = 0, totalDeduction = 0;

      data.forEach(({ skill, value, deduction }) => {
        const net = value - deduction;
        totalValue += value;
        totalDeduction += deduction;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${skill}</td>
          <td>${value.toFixed(2)}</td>
          <td>${deduction.toFixed(2)}</td>
          <td>${net.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });

      const summaryRow = document.createElement("tr");
      summaryRow.className = "summary";
      summaryRow.innerHTML = `
        <td>Total</td>
        <td>${totalValue.toFixed(2)}</td>
        <td>${totalDeduction.toFixed(2)}</td>
        <td>${(totalValue - totalDeduction).toFixed(2)}</td>
      `;
      tbody.appendChild(summaryRow);

      container.appendChild(table);
    }
  </script>
</body>
</html>
