<!DOCTYPE html>
<html>
<head>
  <title>User Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Dashboard</h2>

  <select id="eventSelect" onchange="renderSubmissionRows()">
    <option value="">Select Event</option>
    <option value="FX">FX</option>
    <option value="PH">PH</option>
    <option value="SR">SR</option>
    <option value="VT">VT</option>
    <option value="PB">PB</option>
    <option value="HB">HB</option>
  </select>

  <div id="adminArea">
    <input id="adminCode" placeholder="Enter admin code" />
    <button onclick="checkAdminCode()">Go</button>
  </div>

  <section id="submissionSection" style="display:none;">
    <div id="submissionRows"></div>
    <button id="submitBtn">Submit</button>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      databaseURL: "https://extracker-d2148-default-rtdb.firebaseio.com",
      projectId: "extracker-d2148",
      storageBucket: "extracker-d2148.appspot.com",
      messagingSenderId: "203023038950",
      appId: "1:203023038950:web:bc5cc0633c129e0cb2fe27",
      measurementId: "G-XPQ7THPEKD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUserId = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("submissionSection").style.display = "block";
      } else {
        window.location.href = "index.html";
      }
    });

    function renderSubmissionRows() {
      const event = document.getElementById("eventSelect").value;
      const container = document.getElementById("submissionRows");
      container.innerHTML = "";

      let labels = [];
      if (event === "VT") {
        labels = ["Preflight", "In Air", "Landing"];
      } else if (event) {
        labels = Array.from({ length: 8 }, (_, i) => `Skill ${i + 1}`);
      }

      labels.forEach((label, index) => {
        const row = document.createElement("div");
        row.innerHTML = `
          <label>${label}</label>
          <input id="skill_${index}" placeholder="${label}" />
          <input id="value_${index}" type="number" placeholder="Value" />
          <input id="deduction_${index}" type="number" placeholder="Deduction" />
          <br>
        `;
        container.appendChild(row);
      });
    }

    function checkAdminCode() {
      const code = document.getElementById("adminCode").value.trim();
      if (code === "gymnastics") {
        window.location.href = "breakdown.html";
      } else {
        alert("Incorrect admin code.");
      }
    }

    document.getElementById("submitBtn").onclick = async () => {
      const event = document.getElementById("eventSelect").value;
      if (!event) {
        alert("Please select an event.");
        return;
      }

      const rows = event === "VT" ? 3 : 8;
      for (let i = 0; i < rows; i++) {
        const skill = document.getElementById(`skill_${i}`).value.trim();
        const value = parseFloat(document.getElementById(`value_${i}`).value);
        const deduction = parseFloat(document.getElementById(`deduction_${i}`).value);

        if (!skill || isNaN(value) || isNaN(deduction)) continue;

        const submission = {
          userId: currentUserId,
          event,
          skill,
          value,
          deduction,
          timestamp: Date.now()
        };

        const ref = db.ref('users/' + currentUserId + '/submissions').push();
        const id = ref.key;
        await ref.set(submission);
        await db.ref('allSubmissions/' + id).set(submission);
      }

      alert("Submissions saved!");
      renderSubmissionRows(); // Reset inputs
    };
  </script>
</body>
</html>
