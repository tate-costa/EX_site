<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gymnastics Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background-color: #f4f4f4; }
    .submitBtn, #loginBtn, #seeBreakdownBtn {
      margin-top: 10px; padding: 8px 16px;
      background-color: #0077cc; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .submitStatus { font-style: italic; color: green; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; padding: 4px; }
  </style>
</head>
<body>
  <h1>Welcome to Your Gymnastics Dashboard</h1>
  <button id="loginBtn" style="display:none;">Sign in with Google</button>
  <p id="userStatus">Checking login status...</p>

  <label for="eventSelect">Select Event:</label>
  <select id="eventSelect" disabled>
    <option value="">--Choose an event--</option>
    <option value="FX">FX</option>
    <option value="PH">PH</option>
    <option value="SR">SR</option>
    <option value="VT">VT</option>
    <option value="PB">PB</option>
    <option value="HB">HB</option>
  </select>

  <div id="eventForm"></div>
  <button id="seeBreakdownBtn">See Breakdown</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148",
      appId: "1:123456789012:web:abcdef123456"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUserId = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("userStatus").textContent = `Logged in as: ${user.displayName || user.email}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("eventSelect").disabled = false;
      } else {
        document.getElementById("userStatus").textContent = "Not signed in";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("eventSelect").disabled = true;
      }
    });

    document.getElementById("loginBtn").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    });

    document.getElementById("seeBreakdownBtn").addEventListener("click", () => {
      if (!currentUserId) return alert("Please sign in first");
      localStorage.setItem("userId", currentUserId);
      window.location.href = "breakdown.html";
    });

    const eventSelect = document.getElementById("eventSelect");
    const eventForm = document.getElementById("eventForm");

    eventSelect.addEventListener("change", () => {
      const selectedEvent = eventSelect.value;
      eventForm.innerHTML = "";
      if (!selectedEvent) return;

      const eventRowCounts = { FX: 8, PH: 8, SR: 8, PB: 8, HB: 8, VT: 3 };
      const rowCount = eventRowCounts[selectedEvent] || 1;

      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr><th>Skill</th><th>Value</th><th>Deduction</th></tr></thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      for (let i = 0; i < rowCount; i++) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" class="skillInput"></td>
          <td><input type="number" class="valueInput"></td>
          <td><input type="number" class="deductionInput"></td>
        `;
        tbody.appendChild(row);
      }

      eventForm.appendChild(table);

      const submitAllBtn = document.createElement("button");
      submitAllBtn.textContent = "Submit All";
      submitAllBtn.className = "submitBtn";
      eventForm.appendChild(submitAllBtn);

      submitAllBtn.addEventListener("click", () => {
        if (!currentUserId) return alert("Please sign in first");

        const skills = Array.from(document.querySelectorAll(".skillInput")).map(i => i.value.trim());
        const values = Array.from(document.querySelectorAll(".valueInput")).map(i => parseFloat(i.value));
        const deductions = Array.from(document.querySelectorAll(".deductionInput")).map(i => parseFloat(i.value));
        const timestamp = new Date().toISOString();

        let submittedCount = 0;

        skills.forEach((skill, i) => {
          if (!skill || isNaN(values[i]) || isNaN(deductions[i])) return;

          db.collection("submissions").add({
            userId: currentUserId,
            event: selectedEvent,
            skill,
            value: values[i],
            deduction: deductions[i],
            timestamp
          }).then(() => {
            submittedCount++;
            if (submittedCount === skills.length) {
              const status = document.createElement("p");
              status.className = "submitStatus";
              status.textContent = `âœ… All ${submittedCount} rows submitted!`;
              eventForm.appendChild(status);
            }
          }).catch(console.error);
        });
      });
    });
  </script>
</body>
</html>
