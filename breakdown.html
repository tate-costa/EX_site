<!DOCTYPE html>
<html>
<head>
  <title>Breakdown Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, input[type="range"] { margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .highlight-red { background-color: #ffe5e5; }
  </style>
</head>
<body>
  <h1>Skill Deduction Breakdown</h1>

  <label>Filter by Event:</label>
  <select id="eventFilter" onchange="applyFilters()">
    <option value="">All Events</option>
    <option value="FX">FX</option>
    <option value="PH">PH</option>
    <option value="SR">SR</option>
    <option value="VT">VT</option>
    <option value="PB">PB</option>
    <option value="HB">HB</option>
  </select>

  <label>Filter by User ID:</label>
  <select id="userFilter" onchange="applyFilters()">
    <option value="">All Users</option>
  </select>

  <label>Show submissions from the past <span id="dayLabel">14</span> days:</label>
  <input type="range" id="dayRange" min="0" max="60" value="14" oninput="updateDayLabel()" />

  <label>Chart Mode:</label>
  <select id="chartMode" onchange="applyFilters()">
    <option value="per-skill">Per Skill (Compare Users)</option>
    <option value="per-event">Per Event (Compare Skills)</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>Skill</th>
        <th>Submissions</th>
        <th>Avg Deduction</th>
        <th>Max Deduction</th>
        <th>Min Deduction</th>
      </tr>
    </thead>
    <tbody id="breakdownTableBody"></tbody>
  </table>

  <h3>Overall Diagnostics</h3>
  <div id="diagnostics"></div>

  <h3>User Comparison Chart</h3>
  <canvas id="userSkillChart" height="300"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148",
      storageBucket: "extracker-d2148.appspot.com",
      messagingSenderId: "203023038950",
      appId: "1:203023038950:web:bc5cc0633c129e0cb2fe27",
      measurementId: "G-XPQ7THPEKD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allData = [];

    db.ref('allSubmissions').once('value').then(snapshot => {
      const userSet = new Set();
      snapshot.forEach(child => {
        const entry = child.val();
        if (entry.userId) userSet.add(entry.userId);
        allData.push(entry);
      });

      const userSelect = document.getElementById("userFilter");
      Array.from(userSet).sort().forEach(uid => {
        const option = document.createElement("option");
        option.value = uid;
        option.textContent = uid;
        userSelect.appendChild(option);
      });

      applyFilters();
    });

    function updateDayLabel() {
      const days = document.getElementById("dayRange").value;
      document.getElementById("dayLabel").textContent = days;
      applyFilters();
    }

    function applyFilters() {
      const event = document.getElementById("eventFilter").value;
      const userId = document.getElementById("userFilter").value;
      const days = parseInt(document.getElementById("dayRange").value);
      const cutoff = days > 0 ? Date.now() - (days * 24 * 60 * 60 * 1000) : null;
      const chartMode = document.getElementById("chartMode").value;

      const filtered = allData.filter(entry => {
        if (event && entry.event !== event) return false;
        if (userId && entry.userId !== userId) return false;
        if (cutoff && entry.timestamp < cutoff) return false;
        return true;
      });

      const skillStats = {};
      let totalDeduction = 0;
      let totalCount = 0;
      let maxDeduction = -Infinity;
      let minDeduction = Infinity;
      const skillFrequency = {};
      const userSkillMap = {};

      filtered.forEach(entry => {
        const { userId, skill, deduction, value } = entry;
        if (!skill || isNaN(deduction)) return;

        if (!skillStats[skill]) {
          skillStats[skill] = { count: 0, total: 0, max: deduction, min: deduction, values: [] };
        }

        skillStats[skill].count++;
        skillStats[skill].total += deduction;
        skillStats[skill].max = Math.max(skillStats[skill].max, deduction);
        skillStats[skill].min = Math.min(skillStats[skill].min, deduction);
        if (!isNaN(value)) skillStats[skill].values.push(value);

        totalDeduction += deduction;
        totalCount++;
        skillFrequency[skill] = (skillFrequency[skill] || 0) + 1;

        if (userId) {
          if (!userSkillMap[userId]) userSkillMap[userId] = {};
          if (!userSkillMap[userId][skill]) userSkillMap[userId][skill] = [];
          userSkillMap[userId][skill].push(deduction);
        }

        maxDeduction = Math.max(maxDeduction, deduction);
        minDeduction = Math.min(minDeduction, deduction);
      });

      const tbody = document.getElementById("breakdownTableBody");
      tbody.innerHTML = "";
      Object.entries(skillStats).forEach(([skill, stats]) => {
        const avgDeduction = (stats.total / stats.count).toFixed(2);
        const avgValue = stats.values.length ? (stats.values.reduce((a, b) => a + b, 0) / stats.values.length).toFixed(2) : "N/A";
        const highlight = parseFloat(avgDeduction) > parseFloat(avgValue) ? "highlight-red" : "";

        const row = document.createElement("tr");
        row.className = highlight;
        row.innerHTML = `
          <td>${skill}</td>
          <td>${stats.count}</td>
          <td>${avgDeduction}</td>
          <td>${stats.max}</td>
          <td>${stats.min}</td>
        `;
        tbody.appendChild(row);
      });

      const mostFrequent = Object.entries(skillFrequency).sort((a, b) => b[1] - a[1])[0];
      const diagnostics = document.getElementById("diagnostics");
      diagnostics.innerHTML = `
        <p><strong>Total Submissions:</strong> ${totalCount}</p>
        <p><strong>Overall Avg Deduction:</strong> ${(totalDeduction / totalCount).toFixed(2)}</p>
        <p><strong>Highest Deduction:</strong> ${maxDeduction}</p>
        <p><strong>Lowest Deduction:</strong> ${minDeduction}</p>
        <p><strong>Most Frequent Skill:</strong> ${mostFrequent ? mostFrequent[0] + " (" + mostFrequent[1] + ")" : "N/A"}</p>
      `;

      const ctx = document.getElementById('userSkillChart').getContext('2d');
      if (window.userChart) window.userChart.destroy();

      const skills = [...new Set(filtered.map(e => e.skill).filter(Boolean))];
      const users = Object.keys(userSkillMap);

      if (chartMode === "per-skill") {
        const skill = skills[0]; // default to first skill
        const userData = users.map(userId => {
          const deductions = userSkillMap[userId][skill];
          return deductions ? (deductions.reduce((a, b) => a + b, 0) / deductions
