<!DOCTYPE html>
<html>
<head>
  <title>Breakdown Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, input[type="range"] { margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .highlight-red { background-color: #ffe5e5; }
  </style>
</head>
<body>
  <h1>Skill Deduction Breakdown</h1>

  <label>Filter by Event:</label>
  <select id="eventFilter" onchange="applyFilters()">
    <option value="">All Events</option>
    <option value="FX">FX</option>
    <option value="PH">PH</option>
    <option value="SR">SR</option>
    <option value="VT">VT</option>
    <option value="PB">PB</option>
    <option value="HB">HB</option>
  </select>

  <label>Filter by Name:</label>
  <select id="userFilter" onchange="applyFilters()">
    <option value="">All Users</option>
  </select>

  <label>Show submissions from the past <span id="dayLabel">14</span> days:</label>
  <input type="range" id="dayRange" min="0" max="60" value="14" oninput="updateDayLabel()" />

  <table>
    <thead>
      <tr>
        <th>Skill</th>
        <th>Submissions</th>
        <th>Avg Value</th>
        <th>Avg Deduction</th>
        <th>Max Deduction</th>
        <th>Min Deduction</th>
      </tr>
    </thead>
    <tbody id="breakdownTableBody"></tbody>
  </table>

  <h3>Overall Diagnostics</h3>
  <div id="diagnostics"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3cJtk0c42pNAr3tsi_gQ7_9KcQS-HvgA",
      authDomain: "extracker-d2148.firebaseapp.com",
      projectId: "extracker-d2148",
      storageBucket: "extracker-d2148.appspot.com",
      messagingSenderId: "203023038950",
      appId: "1:203023038950:web:bc5cc0633c129e0cb2fe27",
      measurementId: "G-XPQ7THPEKD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allData = [];

    db.ref('allSubmissions').once('value').then(snapshot => {
      const nameSet = new Set();
      snapshot.forEach(child => {
        const entry = child.val();
        if (entry.userName) nameSet.add(entry.userName);
        allData.push(entry);
      });

      const nameSelect = document.getElementById("userFilter");
      Array.from(nameSet).sort().forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        nameSelect.appendChild(option);
      });

      applyFilters();
    });

    function updateDayLabel() {
      const days = document.getElementById("dayRange").value;
      document.getElementById("dayLabel").textContent = days;
      applyFilters();
    }

    function applyFilters() {
      const event = document.getElementById("eventFilter").value;
      const selectedName = document.getElementById("userFilter").value;
      const days = parseInt(document.getElementById("dayRange").value);
      const cutoff = days > 0 ? Date.now() - (days * 24 * 60 * 60 * 1000) : null;

      const filtered = allData.filter(entry => {
        if (event && entry.event !== event) return false;
        if (selectedName && entry.userName !== selectedName) return false;
        if (cutoff && entry.timestamp < cutoff) return false;
        return true;
      });

      const skillStats = {};
      let totalDeduction = 0;
      let totalCount = 0;
      let maxDeduction = -Infinity;
      let minDeduction = Infinity;
      const skillFrequency = {};

      filtered.forEach(entry => {
        const skill = entry.skill?.trim();
        const deduction = parseFloat(entry.deduction);
        const value = parseFloat(entry.value);
        if (!skill || isNaN(deduction)) return;

        if (!skillStats[skill]) {
          skillStats[skill] = { count: 0, totalDeduction: 0, totalValue: 0, max: deduction, min: deduction, values: [] };
        }

        skillStats[skill].count++;
        skillStats[skill].totalDeduction += deduction;
        skillStats[skill].totalValue += isNaN(value) ? 0 : value;
        skillStats[skill].max = Math.max(skillStats[skill].max, deduction);
        skillStats[skill].min = Math.min(skillStats[skill].min, deduction);
        if (!isNaN(value)) skillStats[skill].values.push(value);

        totalDeduction += deduction;
        totalCount++;
        skillFrequency[skill] = (skillFrequency[skill] || 0) + 1;

        maxDeduction = Math.max(maxDeduction, deduction);
        minDeduction = Math.min(minDeduction, deduction);
      });

      const tbody = document.getElementById("breakdownTableBody");
      tbody.innerHTML = "";
      Object.entries(skillStats).forEach(([skill, stats]) => {
        const avgDeduction = (stats.totalDeduction / stats.count).toFixed(2);
        const avgValue = stats.values.length ? (stats.totalValue / stats.values.length).toFixed(2) : "N/A";
        const highlight = parseFloat(avgDeduction) > parseFloat(avgValue) ? "highlight-red" : "";

        const row = document.createElement("tr");
        row.className = highlight;
        row.innerHTML = `
          <td>${skill}</td>
          <td>${stats.count}</td>
          <td>${avgValue}</td>
          <td>${avgDeduction}</td>
          <td>${stats.max}</td>
          <td>${stats.min}</td>
        `;
        tbody.appendChild(row);
      });

      const mostFrequent = Object.entries(skillFrequency).sort((a, b) => b[1] - a[1])[0];
      const diagnostics = document.getElementById("diagnostics");
      diagnostics.innerHTML = `
        <p><strong>Total Submissions:</strong> ${totalCount}</p>
        <p><strong>Overall Avg Deduction:</strong> ${(totalDeduction / totalCount).toFixed(2)}</p>
        <p><strong>Highest Deduction:</strong> ${maxDeduction}</p>
        <p><strong>Lowest Deduction:</strong> ${minDeduction}</p>
        <p><strong>Most Frequent Skill:</strong> ${mostFrequent ? mostFrequent[0] + " (" + mostFrequent[1] + ")" : "N/A"}</p>
      `;
    }
  </script>
</body>
</html>
